---
- name: Adding elasticsearch GPG keys
  shell: 'wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -'
  tags:
    - 'elasticsearch'

- name: Adding elasticsearch repository
  shell: 'echo "deb http://packages.elastic.co/elasticsearch/1.4/debian stable main" | sudo tee -a /etc/apt/sources.list'
  tags:
    - 'elasticsearch'

- name: Install elasticsearch
  apt:
    name: 'elasticsearch'
    state: 'present'
    update_cache: yes
  notify: init elasticsearch
  tags:
    - 'elasticsearch'

- name: set heap size
  lineinfile:
    dest: '/etc/default/elasticsearch' 
    regexp: '^ES_HEAP_SIZE' 
    line: 'ES_HEAP_SIZE={{ es_heap_size }}'
    state: 'present'
  tags:
    - 'elasticsearch'

- name: Update group gid
  group:
    name: 'elasticsearch'
    gid: '{{ es_gid }}'
    state: 'present'
  when: 'es_gid'
  tags:
    - 'elasticsearch'

- name: Update user uid and gid
  user: name=elasticsearch uid={{ es_uid }} group=elasticsearch state=present
  user:
    name: 'elasticsearch'
    uid: '{{ es_uid }}'
    group: 'elasticsearch'
    state: 'present'
  when: 'es_uid'
  tags:
    - 'elasticsearch'

- name: limits.conf tuning
  lineinfile:
    dest: '/etc/security/limits.conf'
    line: '{{ item }}'
  with_items:
    - 'elasticsearch soft nofile 32000'
    - 'elasticsearch hard nofile 32000'
  tags:
    - 'elasticsearch'

- service:
    name: 'elasticsearch'
    state: 'started'
  when: 'es_manage_service'
  tags:
    - 'elasticsearch'

- include: 'plugins.yml'
  tags:
    - 'elasticsearch'
    - 'elasticsearch-plugins'
